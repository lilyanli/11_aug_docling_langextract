# TODO for 2025-08-13

## High Priority Issues

### 1. Fix LangExtract Parsing Issue
- **Problem**: LangExtract is incorrectly splitting "Exch. Bond" into two separate entities
  - "Exch." extracted as investment_type
  - "Bond" extracted as separate investment_name (different group)
- **Impact**: Causes investment_type to be None, breaking the export process
- **Temporary Fix Applied**: Added None-handling in exporter.py line 25-28
- **Proper Fix Needed**: Investigate why LangExtract splits this and fix the root cause

### 2. Missing Field Extraction
- **Problem**: New fields are not being extracted, all returning null:
  - `interest_fee_receivable`: null
  - `total`: null  
  - `currency_exposure`: null
- **Evidence**: These fields are present in the markdown table but not extracted
- **Location**: Check schema.py and LangExtract configuration
- **Next Steps**: 
  - Verify if LangExtract schema includes these fields
  - Check if field names in prompt match schema exactly
  - Debug extraction grouping logic

## Debugging Session Summary (2025-08-12)

### Cache Issue Investigation
1. **Initial Problem**: Backend server was caching results in memory, preventing file reprocessing
2. **Root Cause**: Server (PID 91469) running since 9:20 PM with persistent in-memory cache
3. **Failed Attempts**: 
   - `pkill -f "python.*start_server.py"` didn't work (process was running as `python server.py`)
   - Multiple restart attempts failed to clear cache
4. **Solution**: Kill specific PID and restart with clean state

### Processing Error
1. **Error**: `AttributeError: 'NoneType' object has no attribute 'lower'`
2. **Location**: exporter.py line 25 in `_company_investment_id` function
3. **Cause**: investment_type was None for "Bond" entity (incorrectly parsed)
4. **Fix Applied**: Added None-check in exporter.py

### Key Findings
- Server was never properly restarted, causing cache persistence
- LangExtract behavior appears non-deterministic with "Exch. Bond" parsing
- New table columns may be affecting entity grouping
- Vision markdown is generated correctly, issue is in extraction phase

## Code Changes Made Today

### 1. server.py
- Added `/api/clear-cache` endpoint (line 437-442)
- Fixed syntax error (removed extra brace on line 315)

### 2. exporter.py  
- Added None-handling for investment_type (lines 25-28)
- Default to "unkn" suffix when investment_type is None

### 3. schema.py (previous changes)
- Added new Investment fields:
  - interest_fee_receivable
  - total
  - currency_exposure

## Files to Review
- `/backend/outputs/run_20250812_232023/extraction.jsonl` - Shows incorrect parsing
- `/backend/outputs/run_20250812_232023/vision_markdown.md` - Correct markdown table
- `/backend/outputs/run_20250812_232023/normalized.json` - Missing new fields

## Testing Notes
- Peak Credit Fund PDF hash: f85dfb9f8e0edaccaf702ff12e6b5d1eee7c7a985849d0dc51fc56dda425c057
- Successfully processes after None-handling fix
- New fields still not extracted despite being in markdown